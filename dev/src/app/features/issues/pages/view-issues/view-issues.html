<h2>Issues</h2>

<nz-card class="mt-20">
  <nz-table #issuesTable [nzData]="issues" style="padding: 0;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Feature</th>
        <th>Priority</th>
        <th>Status</th>
        <th>Date Created</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let issue of issuesTable.data">
        <td>{{ issue.code }}</td>
        <td (click)="viewIssue(issue)">{{ issue.title }}</td>
        <td>{{ issue.feature?.name }}</td>
        <td>{{ issue.priority }}</td>
        <td><nz-tag [nzColor]="getStatusColor(issue.status)">{{ issue.status }}</nz-tag></td>
        <td>{{ issue.createdAt | date: 'short' }}</td>
      </tr>
    </tbody>
  </nz-table>
</nz-card>

<nz-modal [(nzVisible)]="issueModalVisible" (nzOnCancel)="closeIssueModal()" [nzFooter]="null" nzWidth="800px">
  <ng-container *nzModalContent>
    <h2>{{ selectedIssue?.title }}</h2>
    <div class="mt-10" style="display: grid; grid-template-columns: 1fr 200px; column-gap: 20px;">
      <div>
        <div class="flex gap-20">
          <p><small>ID</small><br/>
            {{ selectedIssue?.code }}
          </p>

          <p><small>Priority</small><br/>
            <nz-select [ngModel]="selectedIssue?.priority" style="width: 120px;" (ngModelChange)="onPriorityChange($event)">
              <nz-option *ngFor="let priority of ['low', 'medium', 'high', 'critical']" [nzValue]="priority" [nzLabel]="priority"></nz-option>
            </nz-select>
          </p>

          <p><small>Status</small><br/>
            <nz-select [ngModel]="selectedIssue?.status" style="width: 120px;" (ngModelChange)="onStatusChange($event)">
              <nz-option *ngFor="let status of ['open', 'in_progress', 'resolved']" [nzValue]="status" [nzLabel]="status"></nz-option>
            </nz-select>
          </p>

          <p><small>Date Created</small><br/>
            {{ selectedIssue?.createdAt | date: 'short' }}
          </p>
        </div>

        @if (selectedIssue?.description) {
        <div class="mt-10">
          <div style="font-weight: bold;">Description</div>
          <p style="white-space: pre-wrap;">{{ selectedIssue?.description }}</p>
        </div>
        }

        @if (selectedIssue?.stepsToReproduce?.length) {
        <div class="mt-10">
          <div style="font-weight: bold;">Steps to Reproduce</div>
          <ul>
            <li *ngFor="let step of selectedIssue?.stepsToReproduce">{{ step.step }}</li>
          </ul>
        </div>
        }

        @if (selectedIssue?.attachments?.length) {
        <div class="mt-10">
          <div style="font-weight: bold;">Attachments</div>
          <ul>
            <li *ngFor="let attachment of selectedIssue?.attachments">
              <img [src]="attachment" width="150" height="150" />
            </li>
          </ul>
        </div>
        }
      </div>

      <div>
        <div class="mt-10">
          <b>Feature</b>
          <div>{{ selectedIssue?.feature?.name }}</div>
        </div>
        <div class="mt-10">
          <b>Test Case</b>
          <div>{{ selectedIssue?.testCase?.name }}</div>
        </div>
        <div class="mt-10">
          <div style="font-weight: bold;">Edgecase:</div>
          <div class="mt-5" style="display: grid; grid-template-columns: 50px 1fr;">
            <b>If</b>{{ selectedIssue?.edgeCase?.title }}
            <b>then</b>{{ selectedIssue?.edgeCase?.expectation }}
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</nz-modal>
