@if (ready) {
<div class="mt-20">
    @if (plan) {
    <h2>Edit Test Plan</h2>
    } @else {
    <h2>Create Test Plan</h2>
    }

    <div>
        Name:<br />
        <input nz-input [formControl]="$any(formGroup.get('name'))" style="width: 100%" />
    </div>

    <div class="mt-20">
        Description:<br />
        <textarea nz-input [formControl]="$any(formGroup.get('description'))" style="width: 100%"></textarea>
    </div>

    <div class="mt-20">
        Environments:<br />
        <div>
          @for (environment of $any(formGroup.get('environments'))?.controls; track environment) {
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input nz-input type="text" style="width: 160px;" [formControl]="environment.get('name')" placeholder="Local" />
            <input nz-input type="text" style="flex: 1;" [formControl]="environment.get('url')" placeholder="http://localhost:4200" />
          </div>
          }
          <button nz-button (click)="addEnvironment()">Add Environment</button>
        </div>
    </div>

    <div class="mt-20">
        Features:<br />
        <nz-collapse [nzBordered]="false">
            @for (feature of getSortedFeatures(formGroup.get('features')); track feature; let featureIndex = $index) {
                <nz-collapse-panel [nzHeader]="templateHeader">
                    <ng-template #templateHeader>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1; font-weight: 600;">{{ $any(feature.get('name')).value }}</div>

                            <button nz-button (click)="moveFeatureUp(featureIndex)">
                                <i nz-icon nzType="up"></i>
                            </button>
                            <button nz-button (click)="moveFeatureDown(featureIndex)">
                                <i nz-icon nzType="down"></i>
                            </button>
                            <button nz-button nz-popconfirm nzPopconfirmTitle="Are you sure you want to delete this?" (nzOnConfirm)="deleteFeatureAt($any(formGroup.get('features')), featureIndex)">
                                <i nz-icon nzType="delete"></i>
                            </button>
                        </div>
                    </ng-template>

                    <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                        <input nz-input [formControl]="$any(feature.get('name'))" style="width: 440px;" placeholder="Login" />
                        <input nz-input [formControl]="$any(feature.get('url'))" style="width: 440px;" placeholder="/login" />

                        <div><b>Test Cases</b> ({{ $any(feature.get('testCases')).controls.length }})</div>
                    </div>

                    <div>
                        @for (testCase of getSortedTestCases(feature.get('testCases')); track testCase; let i = $index) {
                        <div style="border-top: 1px solid gray; padding-top: 10px; display: flex; gap: 10px;" class="mt-10">
                            <div style="flex: 1; background: #f3f3f3; padding: 10px;">
                                <input nz-input [formControl]="$any(testCase.get('name'))" placeholder="Login with valid credentials" />
                                <br />
                                <textarea
                                    nz-input
                                    [formControl]="$any(testCase.get('description'))"
                                    style="margin-top: 5px; width: 100%;"
                                    placeholder="Describe the test case..."
                                ></textarea>

                                <!-- Steps to test -->
                                <div class="mt-20">
                                    <b>Steps to test</b>
                                    <app-steps-form [formControl]="$any(testCase.get('stepsToTest'))"></app-steps-form>
                                </div>

                                <!-- Edge cases -->
                                <div class="mt-20">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <b>Edge Cases</b>
                                        @if (!testCase.get('edgeCases').controls?.length) {
                                        <button nz-button (click)="showEdgeCaseModal(testCase)" nzType="link">
                                            <nz-icon nzType="plus"></nz-icon> Add Edge Case
                                        </button>
                                        }
                                    </div>

                                    <nz-list [nzHeader]="''">
                                        @for (edgeCase of $any(testCase.get('edgeCases').controls); track edgeCase) {
                                        <nz-list-item style="display: grid; grid-template-columns: 20px 1fr; column-gap: 20px;">
                                            <span style="font-size: 21px;">ðŸ”¨</span>
                                            <div>
                                                <div><b>If:</b> <i class="source-code-pro">{{edgeCase.get('title').value}}</i></div>
                                                <div><b>Expected Result:</b> <span class="source-code-pro">{{edgeCase.get('expectation').value}}</span></div>
                                            </div>
                                        </nz-list-item>
                                        }
                                    </nz-list>

                                    @if (testCase.get('edgeCases').controls?.length) {
                                    <button nz-button (click)="showEdgeCaseModal(testCase)" nzBlock>ðŸ”¨ Set Edge Case</button>
                                    }
                                </div>
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <button nz-button (click)="moveUp(feature.get('testCases'), i)">
                                    <i nz-icon nzType="up"></i>
                                </button>
                                <button nz-button (click)="moveDown(feature.get('testCases'), i)">
                                    <i nz-icon nzType="down"></i>
                                </button>
                                <button nz-button nz-popconfirm nzPopconfirmTitle="Are you sure you want to delete this?" (nzOnConfirm)="deleteTestCaseAt($any(feature.get('testCases')), i)">
                                    <i nz-icon nzType="delete"></i>
                                </button>
                            </div>
                        </div>
                        }
                        <div class="mt-20">
                            <button nz-button (click)="addTestCase($any(feature.get('testCases')))" nzBlock>Add new Test Case</button>
                        </div>
                    </div>
                </nz-collapse-panel>
            }
        </nz-collapse>
    </div>

    <div class="mt-40">
        <button nz-button style="width: 100%;" (click)="addToFeatures()">ADD FEATURE/MODULE</button>
    </div>

    <div style="display: flex; flex-direction: row; justify-content: flex-end; gap: 10px;" class="mt-40">
        <button nz-button>Cancel</button>
        <button nz-button (click)="save()" nzType="primary">Submit</button>
    </div>
</div>
}

@if (!ready && readyError) {
    <h1>Page failed to load</h1>
}



<nz-modal [(nzVisible)]="edgeCaseModalVisible" (nzOnCancel)="closeEdgeCaseModal()" [nzOkDisabled]="!edgeCaseForm?.valid" (nzOnOk)="saveEdgeCases()" nzTitle="Edge Cases">
    <ng-container *nzModalContent>
    @if (edgeCaseModalVisible) {
        <div nz-form nzLayout="vertical" [formGroup]="edgeCaseForm">
            @for (edgeCase of $any(edgeCaseForm).controls; track edgeCase) {
            <nz-form-item style="display: grid; grid-template-columns: 46px 1fr;">
                <label>If:</label>
                <textarea nz-input rows="2" [formControl]="edgeCase.get('title')" placeholder="If email is valid but password is wrong"></textarea>
            </nz-form-item>
            <nz-form-item style="display: grid; grid-template-columns: 46px 1fr;">
                <label>Then:</label>
                <textarea nz-input rows="2" [formControl]="edgeCase.get('expectation')" placeholder="show error"></textarea>
            </nz-form-item>

            <nz-divider></nz-divider>
            }
            <div class="mt-20">
                <button nz-button (click)="addEdgeCaseInput()" style="width: 100%;">
                    <nz-icon nzType="plus"></nz-icon>
                    Add Edge Case
                </button>
            </div>
        </div>
    }
    </ng-container>
</nz-modal>